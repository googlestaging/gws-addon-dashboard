-- This file contains the BigQuery query for "DAU Query". See README.gs for full instructions before executing this query.
-- Also note the following before executing this query:
-- * Replace all occurrences of "<your-gcp-project-id>" with your GCP project's ID.
-- * Replace all occurrences of "<yourDataSetName>" with your data set name (i.e. "flubarooUsageData"). This is 
--   the same data set you created when setting up log routing.
-- * Run this query once with the "CREATE OR REPLACE TABLE" statement to create the
--   table initially. Afterwards comment out that line, and uncomment the "INSERT" statement 
--   that comes after it (to be used from then on).

-- Use today's date when executing:
DECLARE calc_date DATETIME DEFAULT CURRENT_DATETIME();

-- Alternately, use line below (instead of line above) to do a one-off data 
-- regeneration for a specific day. Example shown for April 13, 2023.
--DECLARE calc_date TIMESTAMP DEFAULT '2023-04-13 00:00:00';



-- The lengthy TimezoneToCountry function below converts a timezone
-- string (i.e. 'Europe/Paris') to its corresponding country (i.e. 'France').
CREATE TEMP FUNCTION TimezoneToCountry(tz STRING)
  RETURNS STRING
  AS (
  CASE 
  WHEN tz = 'America/Adak' THEN 'United States'
  WHEN tz = 'America/Anchorage' THEN 'United States'
  WHEN tz = 'America/Anguilla' THEN 'Anguilla'
  WHEN tz = 'America/Antigua' THEN 'Antigua and Barbuda'
  WHEN tz = 'America/Araguaina' THEN 'Brazil'
  WHEN tz = 'America/Argentina/Buenos_Aires' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Catamarca' THEN 'Argentina'
  WHEN tz = 'America/Argentina/ComodRivadavia' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Cordoba' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Jujuy' THEN 'Argentina'
  WHEN tz = 'America/Argentina/La_Rioja' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Mendoza' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Rio_Gallegos' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Salta' THEN 'Argentina'
  WHEN tz = 'America/Argentina/San_Juan' THEN 'Argentina'
  WHEN tz = 'America/Argentina/San_Luis' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Tucuman' THEN 'Argentina'
  WHEN tz = 'America/Argentina/Ushuaia' THEN 'Argentina'
  WHEN tz = 'America/Aruba' THEN 'Aruba'
  WHEN tz = 'America/Asuncion' THEN 'Paraguay'
  WHEN tz = 'America/Atikokan' THEN 'Canada'
  WHEN tz = 'America/Atka' THEN 'United States'
  WHEN tz = 'America/Bahia' THEN 'Brazil'
  WHEN tz = 'America/Barbados' THEN 'Barbados'
  WHEN tz = 'America/Belem' THEN 'Brazil'
  WHEN tz = 'America/Belize' THEN 'Belize'
  WHEN tz = 'America/Blanc-Sablon' THEN 'Canada'
  WHEN tz = 'America/Boa_Vista' THEN 'Brazil'
  WHEN tz = 'America/Bogota' THEN 'Colombia'
  WHEN tz = 'America/Boise' THEN 'United States'
  WHEN tz = 'America/Buenos_Aires' THEN 'Argentina'
  WHEN tz = 'America/Cambridge_Bay' THEN 'Canada'
  WHEN tz = 'America/Campo_Grande' THEN 'Brazil'
  WHEN tz = 'America/Cancun' THEN 'Mexico'
  WHEN tz = 'America/Caracas' THEN 'Venezuela'
  WHEN tz = 'America/Catamarca' THEN 'Argentina'
  WHEN tz = 'America/Cayenne' THEN 'French Guiana'
  WHEN tz = 'America/Cayman' THEN 'Cayman Islands'
  WHEN tz = 'America/Chicago' THEN 'United States'
  WHEN tz = 'America/Chihuahua' THEN 'Mexico'
  WHEN tz = 'America/Coral_Harbour' THEN 'Canada'
  WHEN tz = 'America/Cordoba' THEN 'Argentina'
  WHEN tz = 'America/Costa_Rica' THEN 'Costa Rica'
  WHEN tz = 'America/Cuiaba' THEN 'Brazil'
  WHEN tz = 'America/Curacao' THEN 'Curaçao'
  WHEN tz = 'America/Danmarkshavn' THEN 'Greenland'
  WHEN tz = 'America/Dawson' THEN 'Canada'
  WHEN tz = 'America/Dawson_Creek' THEN 'Canada'
  WHEN tz = 'America/Denver' THEN 'United States'
  WHEN tz = 'America/Detroit' THEN 'United States'
  WHEN tz = 'America/Dominica' THEN 'Dominica'
  WHEN tz = 'America/Edmonton' THEN 'Canada'
  WHEN tz = 'America/Eirunepe' THEN 'Brazil'
  WHEN tz = 'America/El_Salvador' THEN 'El Salvador'
  WHEN tz = 'America/Ensenada' THEN 'Mexico'
  WHEN tz = 'America/Fortaleza' THEN 'Brazil'
  WHEN tz = 'America/Fort_Wayne' THEN 'United States'
  WHEN tz = 'America/Glace_Bay' THEN 'Canada'
  WHEN tz = 'America/Godthab' THEN 'Greenland'
  WHEN tz = 'America/Goose_Bay' THEN 'Canada'
  WHEN tz = 'America/Grand_Turk' THEN 'Turks and Caicos Islands'
  WHEN tz = 'America/Grenada' THEN 'Grenada'
  WHEN tz = 'America/Guadeloupe' THEN 'Guadeloupe'
  WHEN tz = 'America/Guatemala' THEN 'Guatemala'
  WHEN tz = 'America/Guayaquil' THEN 'Ecuador'
  WHEN tz = 'America/Guyana' THEN 'Guyana'
  WHEN tz = 'America/Halifax' THEN 'Canada'
  WHEN tz = 'America/Havana' THEN 'Cuba'
  WHEN tz = 'America/Hermosillo' THEN 'Mexico'
  WHEN tz = 'America/Indiana/Indianapolis' THEN 'United States'
  WHEN tz = 'America/Indiana/Knox' THEN 'United States'
  WHEN tz = 'America/Indiana/Marengo' THEN 'United States'
  WHEN tz = 'America/Indiana/Petersburg' THEN 'United States'
  WHEN tz = 'America/Indiana/Tell_City' THEN 'United States'
  WHEN tz = 'America/Indiana/Vevay' THEN 'United States'
  WHEN tz = 'America/Indiana/Vincennes' THEN 'United States'
  WHEN tz = 'America/Indiana/Winamac' THEN 'United States'
  WHEN tz = 'America/Indianapolis' THEN 'United States'
  WHEN tz = 'America/Inuvik' THEN 'Canada'
  WHEN tz = 'America/Iqaluit' THEN 'Canada'
  WHEN tz = 'America/Jamaica' THEN 'Jamaica'
  WHEN tz = 'America/Jujuy' THEN 'Argentina'
  WHEN tz = 'America/Juneau' THEN 'United States'
  WHEN tz = 'America/Kentucky/Louisville' THEN 'United States'
  WHEN tz = 'America/Kentucky/Monticello' THEN 'United States'
  WHEN tz = 'America/Knox_IN' THEN 'United States'
  WHEN tz = 'America/La_Paz' THEN 'Bolivia'
  WHEN tz = 'America/Lima' THEN 'Peru'
  WHEN tz = 'America/Los_Angeles' THEN 'United States'
  WHEN tz = 'America/Louisville' THEN 'United States'
  WHEN tz = 'America/Maceio' THEN 'Brazil'
  WHEN tz = 'America/Managua' THEN 'Nicaragua'
  WHEN tz = 'America/Manaus' THEN 'Brazil'
  WHEN tz = 'America/Marigot' THEN 'Saint Martin (French part)'
  WHEN tz = 'America/Martinique' THEN 'Martinique'
  WHEN tz = 'America/Matamoros' THEN 'Mexico'
  WHEN tz = 'America/Mazatlan' THEN 'Mexico'
  WHEN tz = 'America/Mendoza' THEN 'Argentina'
  WHEN tz = 'America/Menominee' THEN 'United States'
  WHEN tz = 'America/Merida' THEN 'Mexico'
  WHEN tz = 'America/Mexico_City' THEN 'Mexico'
  WHEN tz = 'America/Miquelon' THEN 'Saint Pierre and Miquelon'
  WHEN tz = 'America/Moncton' THEN 'Canada'
  WHEN tz = 'America/Monterrey' THEN 'Mexico'
  WHEN tz = 'America/Montevideo' THEN 'Uruguay'
  WHEN tz = 'America/Montreal' THEN 'Canada'
  WHEN tz = 'America/Montserrat' THEN 'Montserrat'
  WHEN tz = 'America/Nassau' THEN 'Bahamas'
  WHEN tz = 'America/New_York' THEN 'United States'
  WHEN tz = 'America/Nipigon' THEN 'Canada'
  WHEN tz = 'America/Nome' THEN 'United States'
  WHEN tz = 'America/Noronha' THEN 'Brazil'
  WHEN tz = 'America/North_Dakota/Center' THEN 'United States'
  WHEN tz = 'America/North_Dakota/New_Salem' THEN 'United States'
  WHEN tz = 'America/Ojinaga' THEN 'Mexico'
  WHEN tz = 'America/Panama' THEN 'Panama'
  WHEN tz = 'America/Pangnirtung' THEN 'Canada'
  WHEN tz = 'America/Paramaribo' THEN 'Suriname'
  WHEN tz = 'America/Phoenix' THEN 'United States'
  WHEN tz = 'America/Port-au-Prince' THEN 'Haiti'
  WHEN tz = 'America/Porto_Acre' THEN 'Brazil'
  WHEN tz = 'America/Port_of_Spain' THEN 'Trinidad and Tobago'
  WHEN tz = 'America/Porto_Velho' THEN 'Brazil'
  WHEN tz = 'America/Puerto_Rico' THEN 'Puerto Rico'
  WHEN tz = 'America/Rainy_River' THEN 'Canada'
  WHEN tz = 'America/Rankin_Inlet' THEN 'Canada'
  WHEN tz = 'America/Recife' THEN 'Brazil'
  WHEN tz = 'America/Regina' THEN 'Canada'
  WHEN tz = 'America/Resolute' THEN 'Canada'
  WHEN tz = 'America/Rio_Branco' THEN 'Brazil'
  WHEN tz = 'America/Rosario' THEN 'Argentina'
  WHEN tz = 'America/Santa_Isabel' THEN 'Puerto Rico'
  WHEN tz = 'America/Santarem' THEN 'Brazil'
  WHEN tz = 'America/Santiago' THEN 'Chile'
  WHEN tz = 'America/Santo_Domingo' THEN 'Dominican Republic'
  WHEN tz = 'America/Sao_Paulo' THEN 'Brazil'
  WHEN tz = 'America/Scoresbysund' THEN 'Greenland'
  WHEN tz = 'America/Shiprock' THEN 'United States'
  WHEN tz = 'America/St_Barthelemy' THEN 'Saint Barthélemy'
  WHEN tz = 'America/St_Johns' THEN 'Canada'
  WHEN tz = 'America/St_Kitts' THEN 'Saint Kitts and Nevis'
  WHEN tz = 'America/St_Lucia' THEN 'Saint Lucia'
  WHEN tz = 'America/St_Thomas' THEN 'Virgin Islands, U.S.'
  WHEN tz = 'America/St_Vincent' THEN 'Saint Vincent and the Grenadines'
  WHEN tz = 'America/Swift_Current' THEN 'Canada'
  WHEN tz = 'America/Tegucigalpa' THEN 'Honduras'
  WHEN tz = 'America/Thule' THEN 'Greenland'
  WHEN tz = 'America/Thunder_Bay' THEN 'Canada'
  WHEN tz = 'America/Tijuana' THEN 'Mexico'
  WHEN tz = 'America/Toronto' THEN 'Canada'
  WHEN tz = 'America/Tortola' THEN 'Virgin Islands, British'
  WHEN tz = 'America/Vancouver' THEN 'Canada'
  WHEN tz = 'America/Virgin' THEN 'Virgin Islands, U.S.'
  WHEN tz = 'America/Whitehorse' THEN 'Canada'
  WHEN tz = 'America/Winnipeg' THEN 'Canada'
  WHEN tz = 'America/Yakutat' THEN 'United States'
  WHEN tz = 'America/Yellowknife' THEN 'Canada'
  WHEN tz = 'Europe/Amsterdam' THEN 'Netherlands'
  WHEN tz = 'Europe/Andorra' THEN 'Andorra'
  WHEN tz = 'Europe/Athens' THEN 'Greece'
  WHEN tz = 'Europe/Belfast' THEN 'Northern Ireland'
  WHEN tz = 'Europe/Belgrade' THEN 'Serbia'
  WHEN tz = 'Europe/Berlin' THEN 'Germany'
  WHEN tz = 'Europe/Bratislava' THEN 'Slovakia'
  WHEN tz = 'Europe/Brussels' THEN 'Belgium'
  WHEN tz = 'Europe/Bucharest' THEN 'Romania'
  WHEN tz = 'Europe/Budapest' THEN 'Hungary'
  WHEN tz = 'Europe/Chisinau' THEN 'Moldova'
  WHEN tz = 'Europe/Copenhagen' THEN 'Denmark'
  WHEN tz = 'Europe/Dublin' THEN 'Ireland'
  WHEN tz = 'Europe/Gibraltar' THEN 'Gibraltar'
  WHEN tz = 'Europe/Guernsey' THEN 'Guernsey'
  WHEN tz = 'Europe/Helsinki' THEN 'Finland'
  WHEN tz = 'Europe/Isle_of_Man' THEN 'Isle of Man'
  WHEN tz = 'Europe/Istanbul' THEN 'Turkey'
  WHEN tz = 'Europe/Jersey' THEN 'Jersey'
  WHEN tz = 'Europe/Kaliningrad' THEN 'Russian Federation'
  WHEN tz = 'Europe/Kiev' THEN 'Ukraine'
  WHEN tz = 'Europe/Lisbon' THEN 'Portugal'
  WHEN tz = 'Europe/Ljubljana' THEN 'Slovenia'
  WHEN tz = 'Europe/London' THEN 'United Kingdom'
  WHEN tz = 'Europe/Luxembourg' THEN 'Luxembourg'
  WHEN tz = 'Europe/Madrid' THEN 'Spain'
  WHEN tz = 'Europe/Malta' THEN 'Malta'
  WHEN tz = 'Europe/Mariehamn' THEN 'Åland Islands'
  WHEN tz = 'Europe/Minsk' THEN 'Belarus'
  WHEN tz = 'Europe/Monaco' THEN 'Monaco'
  WHEN tz = 'Europe/Moscow' THEN 'Russian Federation'
  WHEN tz = 'Europe/Nicosia' THEN 'Cyprus'
  WHEN tz = 'Europe/Oslo' THEN 'Norway'
  WHEN tz = 'Europe/Paris' THEN 'France'
  WHEN tz = 'Europe/Podgorica' THEN 'Montenegro'
  WHEN tz = 'Europe/Prague' THEN 'Czech Republic'
  WHEN tz = 'Europe/Riga' THEN 'Latvia'
  WHEN tz = 'Europe/Rome' THEN 'Italy'
  WHEN tz = 'Europe/Samara' THEN 'Russian Federation'
  WHEN tz = 'Europe/San_Marino' THEN 'San Marino'
  WHEN tz = 'Europe/Sarajevo' THEN 'Bosnia and Herzegovina'
  WHEN tz = 'Europe/Simferopol' THEN 'Ukraine'
  WHEN tz = 'Europe/Skopje' THEN 'Macedonia'
  WHEN tz = 'Europe/Sofia' THEN 'Bulgaria'
  WHEN tz = 'Europe/Stockholm' THEN 'Sweden'
  WHEN tz = 'Europe/Tallinn' THEN 'Estonia'
  WHEN tz = 'Europe/Tirane' THEN 'Albania'
  WHEN tz = 'Europe/Tiraspol' THEN 'Moldova'
  WHEN tz = 'Europe/Uzhgorod' THEN 'Ukraine'
  WHEN tz = 'Europe/Vaduz' THEN 'Liechtenstein'
  WHEN tz = 'Europe/Vatican' THEN 'Holy See (Vatican City State)'
  WHEN tz = 'Europe/Vienna' THEN 'Austria'
  WHEN tz = 'Europe/Vilnius' THEN 'Lithuania'
  WHEN tz = 'Europe/Volgograd' THEN 'Russian Federation'
  WHEN tz = 'Europe/Warsaw' THEN 'Poland'
  WHEN tz = 'Europe/Zagreb' THEN 'Croatia'
  WHEN tz = 'Europe/Zaporozhye' THEN 'Ukraine'
  WHEN tz = 'Europe/Zurich' THEN 'Switzerland'
  WHEN tz = 'Asia/Aden' THEN 'Yemen'
  WHEN tz = 'Asia/Almaty' THEN 'Kazakhstan'
  WHEN tz = 'Asia/Amman' THEN 'Jordan'
  WHEN tz = 'Asia/Anadyr' THEN 'Russian Federation'
  WHEN tz = 'Asia/Aqtau' THEN 'Kazakhstan'
  WHEN tz = 'Asia/Aqtobe' THEN 'Kazakhstan'
  WHEN tz = 'Asia/Ashgabat' THEN 'Turkmenistan'
  WHEN tz = 'Asia/Ashkhabad' THEN 'Turkmenistan'
  WHEN tz = 'Asia/Baghdad' THEN 'Iraq'
  WHEN tz = 'Asia/Bahrain' THEN 'Bahrain'
  WHEN tz = 'Asia/Baku' THEN 'Azerbaijan'
  WHEN tz = 'Asia/Bangkok' THEN 'Thailand'
  WHEN tz = 'Asia/Beirut' THEN 'Lebanon'
  WHEN tz = 'Asia/Bishkek' THEN 'Kyrgyzstan'
  WHEN tz = 'Asia/Brunei' THEN 'Brunei Darussalam'
  WHEN tz = 'Asia/Calcutta' THEN 'India'
  WHEN tz = 'Asia/Choibalsan' THEN 'Mongolia'
  WHEN tz = 'Asia/Chongqing' THEN 'China'
  WHEN tz = 'Asia/Chungking' THEN 'China'
  WHEN tz = 'Asia/Colombo' THEN 'Sri Lanka'
  WHEN tz = 'Asia/Dacca' THEN 'Bangladesh'
  WHEN tz = 'Asia/Damascus' THEN 'Syrian Arab Republic'
  WHEN tz = 'Asia/Dhaka' THEN 'Bangladesh'
  WHEN tz = 'Asia/Dili' THEN 'Timor-Leste'
  WHEN tz = 'Asia/Dubai' THEN 'United Arab Emirates'
  WHEN tz = 'Asia/Dushanbe' THEN 'Tajikistan'
  WHEN tz = 'Asia/Gaza' THEN 'Palestine'
  WHEN tz = 'Asia/Harbin' THEN 'China'
  WHEN tz = 'Asia/Ho_Chi_Minh' THEN 'Viet Nam'
  WHEN tz = 'Asia/Hong_Kong' THEN 'Hong Kong'
  WHEN tz = 'Asia/Hovd' THEN 'Mongolia'
  WHEN tz = 'Asia/Irkutsk' THEN 'Russian Federation'
  WHEN tz = 'Asia/Istanbul' THEN 'Turkey'
  WHEN tz = 'Asia/Jakarta' THEN 'Indonesia'
  WHEN tz = 'Asia/Jayapura' THEN 'Indonesia'
  WHEN tz = 'Asia/Jerusalem' THEN 'Israel'
  WHEN tz = 'Asia/Kabul' THEN 'Afghanistan'
  WHEN tz = 'Asia/Kamchatka' THEN 'Russian Federation'
  WHEN tz = 'Asia/Karachi' THEN 'Pakistan'
  WHEN tz = 'Asia/Kashgar' THEN 'China'
  WHEN tz = 'Asia/Kathmandu' THEN 'Nepal'
  WHEN tz = 'Asia/Katmandu' THEN 'Nepal'
  WHEN tz = 'Asia/Kolkata' THEN 'India'
  WHEN tz = 'Asia/Krasnoyarsk' THEN 'Russian Federation'
  WHEN tz = 'Asia/Kuala_Lumpur' THEN 'Malaysia'
  WHEN tz = 'Asia/Kuching' THEN 'Malaysia'
  WHEN tz = 'Asia/Kuwait' THEN 'Kuwait'
  WHEN tz = 'Asia/Macao' THEN 'Macao'
  WHEN tz = 'Asia/Macau' THEN 'Macao'
  WHEN tz = 'Asia/Magadan' THEN 'Russian Federation'
  WHEN tz = 'Asia/Makassar' THEN 'Indonesia'
  WHEN tz = 'Asia/Manila' THEN 'Philippines'
  WHEN tz = 'Asia/Muscat' THEN 'Oman'
  WHEN tz = 'Asia/Nicosia' THEN 'Cyprus'
  WHEN tz = 'Asia/Novokuznetsk' THEN 'Russian Federation'
  WHEN tz = 'Asia/Novosibirsk' THEN 'Russian Federation'
  WHEN tz = 'Asia/Omsk' THEN 'Russian Federation'
  WHEN tz = 'Asia/Oral' THEN 'Kazakhstan'
  WHEN tz = 'Asia/Phnom_Penh' THEN 'Cambodia'
  WHEN tz = 'Asia/Pontianak' THEN 'Indonesia'
  WHEN tz = 'Asia/Pyongyang' THEN 'North Korea'
  WHEN tz = 'Asia/Qatar' THEN 'Qatar'
  WHEN tz = 'Asia/Qyzylorda' THEN 'Kazakhstan'
  WHEN tz = 'Asia/Rangoon' THEN 'Myanmar'
  WHEN tz = 'Asia/Riyadh' THEN 'Saudi Arabia'
  WHEN tz = 'Asia/Saigon' THEN 'Vietnam'
  WHEN tz = 'Asia/Sakhalin' THEN 'Russian Federation'
  WHEN tz = 'Asia/Samarkand' THEN 'Uzbekistan'
  WHEN tz = 'Asia/Seoul' THEN 'South Korea'
  WHEN tz = 'Asia/Shanghai' THEN 'China'
  WHEN tz = 'Asia/Singapore' THEN 'Singapore'
  WHEN tz = 'Asia/Taipei' THEN 'Taiwan'
  WHEN tz = 'Asia/Tashkent' THEN 'Uzbekistan'
  WHEN tz = 'Asia/Tbilisi' THEN 'Georgia'
  WHEN tz = 'Asia/Tehran' THEN 'Iran'
  WHEN tz = 'Asia/Tel_Aviv' THEN 'Israel'
  WHEN tz = 'Asia/Thimbu' THEN 'Bhutan'
  WHEN tz = 'Asia/Thimphu' THEN 'Bhutan'
  WHEN tz = 'Asia/Tokyo' THEN 'Japan'
  WHEN tz = 'Asia/Ujung_Pandang' THEN 'Indonesia'
  WHEN tz = 'Asia/Ulaanbaatar' THEN 'Mongolia'
  WHEN tz = 'Asia/Ulan_Bator' THEN 'Mongolia'
  WHEN tz = 'Asia/Urumqi' THEN 'China'
  WHEN tz = 'Asia/Vientiane' THEN 'Lao People\'s Democratic Republic'
  WHEN tz = 'Asia/Vladivostok' THEN 'Russian Federation'
  WHEN tz = 'Asia/Yakutsk' THEN 'Russian Federation'
  WHEN tz = 'Asia/Yekaterinburg' THEN 'Russian Federation'
  WHEN tz = 'Asia/Yerevan' THEN 'Armenia'
  WHEN tz = 'Africa/Abidjan' THEN 'Côte d\'Ivoire'
  WHEN tz = 'Africa/Accra' THEN 'Ghana'
  WHEN tz = 'Africa/Addis_Ababa' THEN 'Ethiopia'
  WHEN tz = 'Africa/Algiers' THEN 'Algeria'
  WHEN tz = 'Africa/Asmara' THEN 'Eritrea'
  WHEN tz = 'Africa/Asmera' THEN 'Eritrea'
  WHEN tz = 'Africa/Bamako' THEN 'Mali'
  WHEN tz = 'Africa/Bangui' THEN 'Central African Republic'
  WHEN tz = 'Africa/Banjul' THEN 'Gambia'
  WHEN tz = 'Africa/Bissau' THEN 'Guinea-Bissau'
  WHEN tz = 'Africa/Blantyre' THEN 'Malawi'
  WHEN tz = 'Africa/Brazzaville' THEN 'Congo'
  WHEN tz = 'Africa/Bujumbura' THEN 'Burundi'
  WHEN tz = 'Africa/Cairo' THEN 'Egypt'
  WHEN tz = 'Africa/Casablanca' THEN 'Morocco'
  WHEN tz = 'Africa/Ceuta' THEN 'Spain'
  WHEN tz = 'Africa/Conakry' THEN 'Guinea'
  WHEN tz = 'Africa/Dakar' THEN 'Senegal'
  WHEN tz = 'Africa/Dar_es_Salaam' THEN 'Tanzania'
  WHEN tz = 'Africa/Djibouti' THEN 'Djibouti'
  WHEN tz = 'Africa/Douala' THEN 'Cameroon'
  WHEN tz = 'Africa/El_Aaiun' THEN 'Western Sahara'
  WHEN tz = 'Africa/Freetown' THEN 'Sierra Leone'
  WHEN tz = 'Africa/Gaborone' THEN 'Botswana'
  WHEN tz = 'Africa/Harare' THEN 'Zimbabwe'
  WHEN tz = 'Africa/Johannesburg' THEN 'South Africa'
  WHEN tz = 'Africa/Kampala' THEN 'Uganda'
  WHEN tz = 'Africa/Khartoum' THEN 'Sudan'
  WHEN tz = 'Africa/Kigali' THEN 'Rwanda'
  WHEN tz = 'Africa/Kinshasa' THEN 'Congo'
  WHEN tz = 'Africa/Lagos' THEN 'Nigeria'
  WHEN tz = 'Africa/Libreville' THEN 'Gabon'
  WHEN tz = 'Africa/Lome' THEN 'Togo'
  WHEN tz = 'Africa/Luanda' THEN 'Angola'
  WHEN tz = 'Africa/Lubumbashi' THEN 'Congo'
  WHEN tz = 'Africa/Lusaka' THEN 'Zambia'
  WHEN tz = 'Africa/Malabo' THEN 'Equatorial Guinea'
  WHEN tz = 'Africa/Maputo' THEN 'Mozambique'
  WHEN tz = 'Africa/Maseru' THEN 'Lesotho'
  WHEN tz = 'Africa/Mbabane' THEN 'Swaziland'
  WHEN tz = 'Africa/Mogadishu' THEN 'Somalia'
  WHEN tz = 'Africa/Monrovia' THEN 'Liberia'
  WHEN tz = 'Africa/Nairobi' THEN 'Kenya'
  WHEN tz = 'Africa/Ndjamena' THEN 'Chad'
  WHEN tz = 'Africa/Niamey' THEN 'Niger'
  WHEN tz = 'Africa/Nouakchott' THEN 'Mauritania'
  WHEN tz = 'Africa/Ouagadougou' THEN 'Burkina Faso'
  WHEN tz = 'Africa/Porto-Novo' THEN 'Benin'
  WHEN tz = 'Africa/Sao_Tome' THEN 'Sao Tome and Principe'
  WHEN tz = 'Africa/Timbuktu' THEN 'Mali'
  WHEN tz = 'Africa/Tripoli' THEN 'Libya'
  WHEN tz = 'Africa/Tunis' THEN 'Tunisia'
  WHEN tz = 'Africa/Windhoek' THEN 'Namibia'
  WHEN tz = 'Australia/ACT' THEN 'Australia'
  WHEN tz = 'Australia/Adelaide' THEN 'Australia'
  WHEN tz = 'Australia/Brisbane' THEN 'Australia'
  WHEN tz = 'Australia/Broken_Hill' THEN 'Australia'
  WHEN tz = 'Australia/Canberra' THEN 'Australia'
  WHEN tz = 'Australia/Currie' THEN 'Australia'
  WHEN tz = 'Australia/Darwin' THEN 'Australia'
  WHEN tz = 'Australia/Eucla' THEN 'Australia'
  WHEN tz = 'Australia/Hobart' THEN 'Australia'
  WHEN tz = 'Australia/LHI' THEN 'Australia'
  WHEN tz = 'Australia/Lindeman' THEN 'Australia'
  WHEN tz = 'Australia/Lord_Howe' THEN 'Australia'
  WHEN tz = 'Australia/Melbourne' THEN 'Australia'
  WHEN tz = 'Australia/North' THEN 'Australia'
  WHEN tz = 'Australia/NSW' THEN 'Australia'
  WHEN tz = 'Australia/Perth' THEN 'Australia'
  WHEN tz = 'Australia/Queensland' THEN 'Australia'
  WHEN tz = 'Australia/South' THEN 'Australia'
  WHEN tz = 'Australia/Sydney' THEN 'Australia'
  WHEN tz = 'Australia/Tasmania' THEN 'Australia'
  WHEN tz = 'Australia/Victoria' THEN 'Australia'
  WHEN tz = 'Australia/West' THEN 'Australia'
  WHEN tz = 'Australia/Yancowinna' THEN 'Australia'
  WHEN tz = 'Indian/Antananarivo' THEN 'Madagascar'
  WHEN tz = 'Indian/Chagos' THEN 'British Indian Ocean Territory'
  WHEN tz = 'Indian/Christmas' THEN 'Christmas Island'
  WHEN tz = 'Indian/Cocos' THEN 'Cocos (Keeling) Islands'
  WHEN tz = 'Indian/Comoro' THEN 'Comoros'
  WHEN tz = 'Indian/Kerguelen' THEN 'French Southern Territories'
  WHEN tz = 'Indian/Mahe' THEN 'Seychelles'
  WHEN tz = 'Indian/Maldives' THEN 'Maldives'
  WHEN tz = 'Indian/Mauritius' THEN 'Mauritius'
  WHEN tz = 'Indian/Mayotte' THEN 'Mayotte'
  WHEN tz = 'Indian/Reunion' THEN 'Réunion'
  WHEN tz = 'Atlantic/Azores' THEN 'Portugal'
  WHEN tz = 'Atlantic/Bermuda' THEN 'Bermuda'
  WHEN tz = 'Atlantic/Canary' THEN 'Spain'
  WHEN tz = 'Atlantic/Cape_Verde' THEN 'Cape Verde'
  WHEN tz = 'Atlantic/Faeroe' THEN 'Faroe Islands'
  WHEN tz = 'Atlantic/Faroe' THEN 'Faroe Islands'
  WHEN tz = 'Atlantic/Jan_Mayen' THEN 'Svalbard and Jan Mayen'
  WHEN tz = 'Atlantic/Madeira' THEN 'Portugal'
  WHEN tz = 'Atlantic/Reykjavik' THEN 'Iceland'
  WHEN tz = 'Atlantic/South_Georgia' THEN 'South Georgia and the South Sandwich Islands'
  WHEN tz = 'Atlantic/Stanley' THEN 'Falkland Islands (Malvinas)'
  WHEN tz = 'Atlantic/St_Helena' THEN 'Saint Helena, Ascension and Tristan da Cunha'
  WHEN tz = 'Pacific/Apia' THEN 'Samoa'
  WHEN tz = 'Pacific/Auckland' THEN 'New Zealand'
  WHEN tz = 'Pacific/Chatham' THEN 'New Zealand'
  WHEN tz = 'Pacific/Easter' THEN 'Chile'
  WHEN tz = 'Pacific/Efate' THEN 'Vanuatu'
  WHEN tz = 'Pacific/Enderbury' THEN 'Canton and Enderbury Islands'
  WHEN tz = 'Pacific/Fakaofo' THEN 'Tokelau'
  WHEN tz = 'Pacific/Fiji' THEN 'Fiji'
  WHEN tz = 'Pacific/Funafuti' THEN 'Tuvalu'
  WHEN tz = 'Pacific/Galapagos' THEN 'Ecuador'
  WHEN tz = 'Pacific/Gambier' THEN 'French Polynesia'
  WHEN tz = 'Pacific/Guadalcanal' THEN 'Solomon Islands'
  WHEN tz = 'Pacific/Guam' THEN 'Guam'
  WHEN tz = 'Pacific/Honolulu' THEN 'United States'
  WHEN tz = 'Pacific/Johnston' THEN 'United States'
  WHEN tz = 'Pacific/Kiritimati' THEN 'Kiribati'
  WHEN tz = 'Pacific/Kosrae' THEN 'Micronesia'
  WHEN tz = 'Pacific/Kwajalein' THEN 'Marshall Islands'
  WHEN tz = 'Pacific/Majuro' THEN 'Marshall Islands'
  WHEN tz = 'Pacific/Marquesas' THEN 'French Polynesia'
  WHEN tz = 'Pacific/Midway' THEN 'United States Minor Outlying Islands'
  WHEN tz = 'Pacific/Nauru' THEN 'Nauru'
  WHEN tz = 'Pacific/Niue' THEN 'Niue'
  WHEN tz = 'Pacific/Norfolk' THEN 'Norfolk Island'
  WHEN tz = 'Pacific/Noumea' THEN 'New Caledonia'
  WHEN tz = 'Pacific/Pago_Pago' THEN 'American Samoa'
  WHEN tz = 'Pacific/Palau' THEN 'Palau'
  WHEN tz = 'Pacific/Pitcairn' THEN 'Pitcairn'
  WHEN tz = 'Pacific/Ponape' THEN 'Micronesia'
  WHEN tz = 'Pacific/Port_Moresby' THEN 'Papua New Guinea'
  WHEN tz = 'Pacific/Rarotonga' THEN 'Cook Islands'
  WHEN tz = 'Pacific/Saipan' THEN 'Northern Mariana Islands'
  WHEN tz = 'Pacific/Samoa' THEN 'Samoa'
  WHEN tz = 'Pacific/Tahiti' THEN 'French Polynesia'
  WHEN tz = 'Pacific/Tarawa' THEN 'Kiribati'
  WHEN tz = 'Pacific/Tongatapu' THEN 'Tonga'
  WHEN tz = 'Pacific/Truk' THEN 'Micronesia'
  WHEN tz = 'Pacific/Wake' THEN 'United States Minor Outlying Islands'
  WHEN tz = 'Pacific/Wallis' THEN 'Wallis and Futuna'
  WHEN tz = 'Pacific/Yap' THEN 'Micronesia'
  WHEN tz = 'Antarctica' THEN 'Antarctica'
  WHEN tz = 'Antarctica/Casey' THEN 'Antarctica'
  WHEN tz = 'Antarctica/Davis' THEN 'Antarctica'
  WHEN tz = 'Antarctica/DumontDUrville' THEN 'Antarctica'
  WHEN tz = 'Antarctica/Macquarie' THEN 'Australia'
  WHEN tz = 'Antarctica/Mawson' THEN 'Antarctica'
  WHEN tz = 'Antarctica/McMurdo' THEN 'Antarctica'
  WHEN tz = 'Antarctica/Palmer' THEN 'Antarctica'
  WHEN tz = 'Antarctica/Rothera' THEN 'Antarctica'
  WHEN tz = 'Antarctica/South_Pole' THEN 'Antarctica'
  WHEN tz = 'Antarctica/Syowa' THEN 'Antarctica'
  WHEN tz = 'Antarctica/Vostok' THEN 'Antarctica'
  WHEN tz = 'Arctic/Longyearbyen' THEN 'Svalbard and Jan Mayen'
  ELSE 'Unknown'
  END
);


-- BigQuery Query Instructions:
-- When running this query for the very first time, comment out the line that starts with "CREATE" to
-- first create the table. After that, comment out that line and uncomment the next line that
-- starts with "INSERT", which will insert new rows into that table each time this query is run. 

CREATE OR REPLACE TABLE `<your-gcp-project-id>.<yourDataSetName>.dailyActiveUsers` AS 
--INSERT `<your-gcp-project-id>.<yourDataSetName>.dailyActiveUsers` (date, country, dau30, dau7, dau1) 

SELECT DATE(DATETIME(calc_date)) as date, A.country as country, A.DAU30 as dau30, IFNULL(BC.DAU7, 0) as dau7, IFNULL(BC.DAU1, 0) as dau1
FROM 

-- Pull 30 DAU by counting distinct user ids over past 30 days. Group by country (based on timezone)
(SELECT TimezoneToCountry(jsonPayload.pingData.timezone) as country,
       COUNT(DISTINCT(jsonPayload.pingData.uid)) AS DAU30, 
FROM `<your-gcp-project-id>.<yourDataSetName>.script_googleapis_com_console_logs_*`
WHERE 
      DATETIME(calc_date) >= DATETIME(timestamp)
AND
      DATETIME_DIFF(DATETIME(calc_date),
                    DATETIME(timestamp),
                    DAY) <= 30
GROUP BY country
ORDER BY DAU30 DESC) AS A

-- Join DAU30 data with a table that already has DAU7 and DAU1 data to form a single table with all 3 metrics, broken out by country
FULL JOIN

(

SELECT DATE(DATETIME(calc_date)) as date, B.country as country, IFNULL(C.DAU1, 0) as dau1, B.DAU7 as dau7,
FROM 

-- Pull 7 DAU by counting distinct user ids over past 7 days. Group by country (based on timezone)
(SELECT TimezoneToCountry(jsonPayload.pingData.timezone) as country,
       COUNT(DISTINCT(jsonPayload.pingData.uid)) AS DAU7, 
FROM `<your-gcp-project-id>.<yourDataSetName>.script_googleapis_com_console_logs_*`
WHERE 
      DATETIME(calc_date) >= DATETIME(timestamp)
AND
      DATETIME_DIFF(DATETIME(calc_date),
                    DATETIME(timestamp),
                    DAY) <= 7
GROUP BY country
) AS B

-- Join DAU7 data with DAU1 data into a single table
FULL JOIN

-- Pull 1 DAU by counting distinct user ids over past 1 day. Group by country (based on timezone)
(SELECT TimezoneToCountry(jsonPayload.pingData.timezone) as country,
       COUNT(DISTINCT(jsonPayload.pingData.uid)) AS DAU1, 
FROM `<your-gcp-project-id>.<yourDataSetName>.script_googleapis_com_console_logs_*`
WHERE 
      DATETIME(calc_date) >= DATETIME(timestamp)
AND
      DATETIME_DIFF(DATETIME(calc_date),
                    DATETIME(timestamp),
                    DAY) <= 1
GROUP BY country
) AS C

ON (
     B.country = C.country
   )
) AS BC

ON (
    A.country = BC.country
   )

ORDER BY DAU30 DESC;
